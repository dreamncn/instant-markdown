<html>
    <head>
        <title>Instant Markdown</title>
        <style>
            #display, #input {
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
            }
            #input {
                opacity: .01;
            }


            div, p, ul, ol {
                margin: 0;
                padding: 0;
            }
            p:after {
                content: '';
                display: inline-block;
                height: 1em;
            }

            .current {
                background: #ff05;
            }
            .current .current {
                background: #fa05
            }

            .h1 p:first-child {
                font-size: 200%;
                font-weight: bold;
                margin-top: 20pt;
                margin-bottom: 5pt;
                border-bottom: 1px solid #ccc;
            }
            .h2 p:first-child {
                font-size: 160%;
                font-weight: bold;
                margin-top: 10pt;
                margin-bottom: 4pt;
                border-bottom: 1px solid #eee;
            }
            .h3 p:first-child {
                font-size: 140%;
                font-weight: bold;
                margin-top: 5pt;
                margin-bottom: 4pt;
            }

            .quote div {
                margin-left: 21pt;
            }
            .quote div {
                padding-left: 9pt;
                border-left: 1px solid gray;
            }

            .ul ul, .ol ol {
                margin-left: 30pt;
            }

            .hr {
                display: flex;
            }
            .hr::after {
                content: ' ';
                border-bottom: 1px solid gray;
                flex-grow: 1;
                height: 0.6em;
                margin-left: 10pt;
            }
        </style>
        <script>
            let formats = {
                default:{ multiline: true },
                h1:     { start: '#' },
                h2:     { start: '##' },
                h3:     { start: '###' },
                quote:  { start: '>', multiline: true, outerTag: 'div' },
                ul:     { start: '-', multiline: true, listItem: true, outerTag: 'ul', innerTag: 'li' },
                hr:     { match: '---' }
            };

            let input = null;
            let display = null;
            for (f in formats) {
                formats[f] = Object.assign({ className: f, innerTag: 'p' }, formats[f]);
            }
            let formats_all = Object.values(formats);
            let formats_singleline = formats_all.filter(f => !f.multiline);
            let formats_listItem = formats_all.filter(f => f.listItem);

            let sections = [];
            let selection = {};
            function init()
            {
                input = document.querySelector('#input');
                display = document.querySelector('#display');
                input.addEventListener('input', e =>
                {
                    sections = [];
                    let position = 0;
                    let newSection = values => Object.assign({ pos: position, outerPos: position, format: formats.default, innerContent: [], outerContent: [] }, values);
                    let lines = input.value.split('\n');

                    // if (e.inputType === 'insertLineBreak') {}

                    let startNewSection = true;
                    lines.forEach(line =>
                    {
                        let nextPosition = position + 1 + line.length;
                        line = { pos: position, text: line };

                        // empty line
                        if (line.text.trim() === '') {
                            if (!sections.length)
                                sections.push(newSection({ outerContent: [line] }));
                            else
                                sections.last().outerContent.push(line);
                            startNewSection = true;
                        }
                        else {
                            let format = getLineFormat(line.text);
                            let prevSection = sections.length ? sections.last() : null;
                            let prevFormat = prevSection ? prevSection.format : null;
                            // formatted
                            if (format !== formats.default) {
                                if (format.listItem && prevFormat && prevFormat.listItem)
                                    prevSection.innerContent.push([line]);
                                else
                                    sections.push(newSection({ format: format, innerContent: [[line]] }));
                                startNewSection = !!getLineFormat(line.text, formats_singleline);
                            }
                            // plain text
                            else {
                                if (prevFormat && prevFormat.listItem && !prevSection.outerContent.length)
                                    prevSection.innerContent.last().push(line);
                                else if (startNewSection)
                                    sections.push(newSection({ innerContent: [[line]] }));
                                else
                                    sections.last().innerContent.push([line]);
                                startNewSection = false;
                            }
                            sections.last().outerPos = nextPosition;
                        }
                        position = nextPosition;
                    });
                    console.log(sections);
                    display.innerHTML = '';
                    sections.forEach(section =>
                    {
                        let format = section.format;
                        section.htmlTag = document.createElement('div');
                        section.htmlTag.className = format.className;

                        if (section.innerContent.length) {
                            let container = section.htmlTag;
                            if (format.outerTag) {
                                container = document.createElement(format.outerTag);
                                section.htmlTag.appendChild(container);
                            }
                            section.innerContent.forEach(lines =>
                            {
                                let tag = document.createElement(format.innerTag);
                                tag.innerHTML = lines.map(l => l.text).join('<br />');
                                container.appendChild(tag);
                            });
                        }
                        if (section.outerContent.length) {
                            for (l in section.outerContent) {
                                let line = section.outerContent[l];
                                let tag = document.createElement(formats.default.innerTag);
                                tag.innerHTML = line.text;
                                section.htmlTag.appendChild(tag);
                                section.outerContent[l] = { line: line, htmlTag: tag };
                            }
                        }
                        display.appendChild(section.htmlTag);
                    });
                    selection = {};
                    updateSelection();
                });
                input.dispatchEvent(new Event('input'));
            }
            function updateSelection()
            {
                if (selection.section)
                    selection.section.htmlTag.classList.remove('current');
                if (selection.line)
                    selection.line.htmlTag.classList.remove('current');

                let selStart = input.selectionStart;
                for (s in sections) {
                    let section = sections[s];
                    if (section.pos > selStart) {
                        selection.section = sections[s - 1];
                        break;
                    }
                }
                if (!selection.section)
                    selection.section = sections.last();
                selection.section.htmlTag.classList.add('current');

                if (selection.section.outerPos > selStart) {
                }
                else {
                    for (o in selection.section.outerContent) {
                        let oc = selection.section.outerContent[o];
                        if (oc.line.pos > selStart) {
                            selection.line = selection.section.outerContent[o - 1];
                            break;
                        }
                    }
                    if (!selection.line)
                        selection.line = selection.section.outerContent.last();
                    selection.line.htmlTag.classList.add('current');
                }
            }
            function getLineFormat(line, formatsToCheck = null)
            {
                let check = (line, format) =>
                    (format.match === line)
                        || (format.start
                            && (format.start === line
                                || line.startsWith(format.start + ' ')
                                || line.startsWith(format.start + '\xa0')
                                || line.startsWith(format.start + '&nbsp;')));

                let formatsArray = formatsToCheck || formats_all;
                for (i in formatsArray) {
                    if (check(line, formatsArray[i]))
                        return formatsArray[i];
                }
                return formatsToCheck ? null : formats.default;
            }
            Object.defineProperty(Array.prototype, 'last', {
                value: function() { return this.length ? this[this.length - 1] : null; },
                enumerable: false
            });
        </script>
    </head>
    <body onload="init()"><div id="display"></div><textarea id="input">Start here...</textarea></body>
</html>