<html>
    <head>
        <title>Instant Markdown</title>
        <style>
            #display, #input {
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
            }
            #input {
                opacity: .01;
            }


            div, p, ul, ol {
                margin: 0;
                padding: 0;
            }
            p:after {
                content: '';
                display: inline-block;
                height: 1em;
            }


            .h1 p:first-child {
                font-size: 200%;
                font-weight: bold;
                margin-top: 20pt;
                margin-bottom: 5pt;
                border-bottom: 1px solid #ccc;
            }
            .h2 p:first-child {
                font-size: 160%;
                font-weight: bold;
                margin-top: 10pt;
                margin-bottom: 4pt;
                border-bottom: 1px solid #eee;
            }
            .h3 p:first-child {
                font-size: 140%;
                font-weight: bold;
                margin-top: 5pt;
                margin-bottom: 4pt;
            }

            .quote div {
                margin-left: 21pt;
            }
            .quote div {
                padding-left: 9pt;
                border-left: 1px solid gray;
            }

            .ul ul, .ol ol {
                margin-left: 30pt;
            }

            .hr {
                display: flex;
            }
            .hr::after {
                content: ' ';
                border-bottom: 1px solid gray;
                flex-grow: 1;
                height: 0.6em;
                margin-left: 10pt;
            }
        </style>
        <script>
            let formats = {
                default:{ multiline: true },
                h1:     { start: '#' },
                h2:     { start: '##' },
                h3:     { start: '###' },
                quote:  { start: '>', multiline: true, outerTag: 'div' },
                ul:     { start: '-', multiline: true, listItem: true, outerTag: 'ul', innerTag: 'li' },
                hr:     { match: '---' }
            };

            let input = null;
            let display = null;
            for (f in formats) {
                formats[f] = Object.assign({ className: f, innerTag: 'p' }, formats[f]);
            }

            let formats_all = Object.values(formats);
            let formats_singleline = formats_all.filter(f => !f.multiline);
            let formats_listItem = formats_all.filter(f => f.listItem);

            let sections = [];
            function init()
            {
                input = document.querySelector('#input');
                display = document.querySelector('#display');
                input.addEventListener('input', e =>
                {
                    // let sel = window.getSelection();
                    // console.log(sel);

                    sections = [];
                    let newSection = values => Object.assign({ format: formats.default, innerContent: [], outerContent: [] }, values);
                    let lines = input.value.split('\n');

                    let startNewSection = true;
                    lines.forEach(line => {
                        // empty line
                        if (line.trim() === '') {
                            if (!sections.length)
                                sections.push(newSection({ outerContent: [line] }));
                            else
                                sections[sections.length - 1].outerContent.push(line);
                            startNewSection = true;
                        }
                        else {
                            let format = getLineFormat(line);
                            let prevSection = sections.length ? sections[sections.length - 1] : null;
                            let prevFormat = prevSection ? prevSection.format : null;
                            // formatted
                            if (format !== formats.default) {
                                console.log(format, prevSection);
                                if (format.listItem && prevFormat && prevFormat.listItem)
                                    prevSection.innerContent.push([line]);
                                else
                                    sections.push(newSection({ format: format, innerContent: [[line]] }));
                                startNewSection = !!getLineFormat(line, formats_singleline);
                            }
                            // plain text
                            else {
                                if (prevFormat && prevFormat.listItem && !prevSection.outerContent.length)
                                    prevSection.innerContent[prevSection.innerContent.length - 1].push(line);
                                else if (startNewSection)
                                    sections.push(newSection({ innerContent: [[line]] }));
                                else
                                    sections[sections.length - 1].innerContent.push([line]);
                                startNewSection = false;
                            }
                        }
                    });
                    let divs = [];
                    console.log(sections);
                    sections.forEach(section =>
                    {
                        let format = section.format;
                        let ot = format.outerTag;
                        let it = format.innerTag;
                        let innerContent = section.innerContent.length ?
                            (ot ? '<' + ot + '>' : '') +
                                '<' + it + '>' +
                                section.innerContent
                                    .map(line => line.join('<br />'))
                                    .join('</' + it + '><' + it + '>') +
                                '</' + it + '>' +
                            (ot ? '</' + ot + '>' : '') : '';
                        let dit = formats.default.innerTag;
                        let outerContent = section.outerContent.length ?
                            '<' + dit + '>' +
                                section.outerContent.join('</' + dit + '><' + dit + '>') +
                            '</' + dit + '>' : '';
                        let className = (format.className !== 'default') ? ' class="' + format.className + '"' : '';
                        divs.push(
                            '<div' + className + '>' +
                                innerContent +
                                outerContent +
                            '</div>');
                    });
                    display.innerHTML = divs.join('');
                });
                input.dispatchEvent(new Event('input'));
            }
            function getLineFormat(line, formatsToCheck = null)
            {
                let check = (line, format) =>
                    (format.match === line)
                        || (format.start
                            && (format.start === line
                                || line.startsWith(format.start + ' ')
                                || line.startsWith(format.start + '\xa0')
                                || line.startsWith(format.start + '&nbsp;')));

                let formatsArray = formatsToCheck || formats_all;
                for (i in formatsArray) {
                    if (check(line, formatsArray[i]))
                        return formatsArray[i];
                }
                return formatsToCheck ? null : formats.default;
            }
            if (!Array.prototype.last) {
                Array.prototype.last = function() { return this.length ? this[this.legnth - 1] : null };
            }
        </script>
    </head>
    <body onload="init()"><div id="display"></div><textarea id="input">Start here...</textarea></body>
</html>