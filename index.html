<html>
    <head>
        <title>Instant Markdown</title>
        <style>
            #display, #input {
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
            }
            #input {
                opacity: .01;
            }


            div, p {
                margin: 0;
            }
            p:after {
                content: '';
                display: inline-block;
                height: 1em;
            }


            div.h1 p:first-child {
                font-size: 200%;
                font-weight: bold;
                margin-top: 20pt;
                margin-bottom: 5pt;
                border-bottom: 1px solid #ccc;
            }
            div.h2 p:first-child {
                font-size: 160%;
                font-weight: bold;
                margin-top: 10pt;
                margin-bottom: 4pt;
                border-bottom: 1px solid #eee;
            }
            div.h3 p:first-child {
                font-size: 140%;
                font-weight: bold;
                margin-top: 5pt;
                margin-bottom: 4pt;
            }

            div.quote div {
                margin-left: 5pt;
                border-left: 1px solid gray;
                padding-left: 10pt;
            }

            div.hr {
                display: flex;
            }
            div.hr::after {
                content: ' ';
                border-bottom: 1px solid gray;
                flex-grow: 1;
                height: 0.6em;
                margin-left: 10pt;
            }
        </style>
        <script>
            let formats = {
                default:{ },
                h1:     { start: '#' },
                h2:     { start: '##' },
                h3:     { start: '###' },
                quote:  { start: '>', multiline: true, outerTag: 'div' },
                ul:     { start: '-', multilineItem: true, outerTag: 'ul', innerTag: 'li' },
                hr:     { match: '---' }
            };

            let input = null;
            let display = null;
            for (f in formats) {
                formats[f] = Object.assign({ className: f, innerTag: 'p' }, formats[f]);
            }

            let formats_all = Object.values(formats);
            let formats_multiline = formats_all.filter(f => f.multiline);
            let formats_multilineItem = formats_all.filter(f => f.multilineItem);

            let sections = [];
            function init()
            {
                input = document.querySelector('#input');
                display = document.querySelector('#display');
                input.addEventListener('input', e =>
                {
                    // let sel = window.getSelection();
                    // console.log(sel);

                    sections = [];
                    let newSection = v => Object.assign({ format: formats.default, innerContent: [], outerContent: [] }, v);
                    let lines = input.value.split('\n');
                    let startNewSection = true;
                    lines.forEach(line => {
                        if (line.trim() === '') {
                            if (!sections.length)
                                sections.push(newSection({ outerContent: [line] }));
                            else
                                sections[sections.length - 1].outerContent.push(line);
                            startNewSection = true;
                        }
                        else {
                            let format = getLineFormat(line, formats_all);
                            if (format !== formats.default) {
                                if (sections.length && formats_multilineItem.includes(format) && format === sections[sections.length - 1].format) {
                                    sections[sections.length - 1].innerContent.push(line);
                                    startNewSection = true;
                                }
                                else {
                                    sections.push(newSection({ format: format, innerContent: [line] }));
                                    startNewSection = getLineFormat(line, formats_multiline) === formats.default;
                                }
                            }
                            else {
                                if (startNewSection)
                                    sections.push(newSection({ innerContent: [line] }));
                                else
                                    sections[sections.length - 1].innerContent.push(line);
                                startNewSection = false;
                            }
                        }
                    });
                    let divs = [];
                    console.log(sections);
                    sections.forEach(section =>
                    {
                        let format = section.format;
                        let ot = format.outerTag;
                        let it = format.innerTag;
                        let innerContent = section.innerContent.length ?
                            (ot ? '<' + ot + '>' : '') +
                                '<' + it + '>' + section.innerContent.join('</' + it + '><' + it + '>') + '</' + it + '>' +
                            (ot ? '</' + ot + '>' : '') : '';
                        let dit = formats.default.innerTag;
                        let outerContent = section.outerContent.length ?
                            '<' + dit + '>' +
                                section.outerContent.join('</' + dit + '><' + dit + '>') +
                            '</' + dit + '>' : '';
                        let className = (format.className !== 'default') ? ' class="' + format.className + '"' : '';
                        divs.push(
                            '<div' + className + '>' +
                                innerContent +
                                outerContent +
                            '</div>');
                    });
                    display.innerHTML = divs.join('');
                });
            }
            function getLineFormat(line, formatsArray)
            {
                let check = (line, format) =>
                    (format.match === line)
                        || (format.start
                            && (format.start === line
                                || line.startsWith(format.start + ' ')
                                || line.startsWith(format.start + '\xa0')
                                || line.startsWith(format.start + '&nbsp;')));

                for (i in formatsArray) {
                    if (check(line, formatsArray[i]))
                        return formatsArray[i];
                }
                return formats.default;
            }
            function lineStyle(div)
            {
                div.className = '';
                let t = div.innerText;
                if (lineStart(t, '#')) {
                    div.className = 'h1';
                }
                else if (lineStart(t, '##')) {
                    div.className = 'h2';
                }
                else if (lineStart(t, '###')) {
                    div.className = 'h3';
                }
                else if (lineStart(t, '>')) {
                    div.className = 'quote';
                }
                else if (t == '---') {
                    div.className = 'hr';
                }
            }
        </script>
    </head>
    <body onload="init()"><div id="display">Start here...</div><textarea id="input"></textarea></body>
</html>